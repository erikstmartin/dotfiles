# -- general ------------------------------------------------------------------m
# Use tmux-256color as default, but preserve capabilities from outer terminal
set -g default-terminal "tmux-256color"
set -as terminal-overrides ",xterm-ghostty:RGB,xterm-ghostty:Tc"
set -as terminal-features ",*:RGB"
set -g focus-events on

setw -g xterm-keys on
set -s escape-time 0                      # faster command sequences
set -sg repeat-time 0                     # set repeat timeout
set -s focus-events on

# Extended keys for modified key support (shift+enter, ctrl+i, etc.)
# Use 'always' to force extended keys even if app doesn't explicitly request them
set -s extended-keys always
# Use CSI-u format for extended keys (compatible with Kitty protocol)
set -s extended-keys-format csi-u
# Mark terminal as supporting extended keys
set -as terminal-features 'xterm*:extkeys'
set -as terminal-features 'xterm-ghostty:extkeys'
set -as terminal-features 'tmux*:extkeys'
# CRITICAL: Also mark these terminals as supporting extkeys in terminal-overrides
# This ensures tmux knows to pass through modified keys even without app query
set -as terminal-overrides ',xterm*:extkeys:Cr=\E]112\007:Cs=\E]12;%p1%s\007'
set -as terminal-overrides ',tmux*:extkeys:Cr=\E]112\007:Cs=\E]12;%p1%s\007'
set -g allow-passthrough on

#set -g prefix2 C-a                        # GNU-Screen compatible prefix
bind C-a send-prefix -2

set -q -g status-utf8 on                  # expect UTF-8 (tmux < 2.2)
setw -q -g utf8 on

set -g history-limit 5000                 # boost history

# Focus events enabled for terminals that support them
set -g focus-events on

# Emacs key bindings in tmux command prompt (prefix + :) are better than
# vi keys, even for vim users
set -g status-keys emacs

# vi keys in copy mode
setw -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

set -g copy-mode-match-style "bg=cyan,fg=black"
set -g copy-mode-current-match-style "bg=magenta,fg=black"

setw -g aggressive-resize on

bind C-q confirm-before -p "kill-session #S? (y/n)" kill-session
bind-key C-c command-prompt -p "Session name:" "new-session -d -s '%%' \; switch-client -t '%%'"
bind-key C-r command-prompt -p "Rename session:" "rename-session '%%'"
bind-key r command-prompt -p "Rename window:" "rename-window '%%'"

# session navigation (Shift-Tab)
bind BTab switch-client -l  # move to last session

# Native tmux choosers with search support (press '/' to filter)
bind s choose-tree -Zs
bind w choose-tree -Zw

# reload configuration
set-environment -g TMUX_PROGRAM "tmux"
set-environment -g TMUX_CONF "~/.tmux.conf"
run '"$TMUX_PROGRAM" -S #{socket_path} set-environment -g TMUX_SOCKET "#{socket_path}"'
bind M-r run '"$TMUX_PROGRAM" ${TMUX_SOCKET:+-S "$TMUX_SOCKET"} source "$TMUX_CONF"' \; display "#{TMUX_CONF} sourced"

# -- display -------------------------------------------------------------------

set -g base-index 1           # start windows numbering at 1
setw -g pane-base-index 1     # make pane numbering consistent with windows

setw -g automatic-rename on   # rename window to reflect current program
set -g renumber-windows on    # renumber windows when a window is closed

set -g set-titles on          # set terminal title

set -g display-panes-time 800 # slightly longer pane indicators display time
set -g display-time 4000      # slightly longer status messages display time

set -g status-interval 5      # redraw status line every 10 seconds

# clear both screen and history
#bind -n C-l send-keys C-l \; run 'sleep 0.2' \; clear-history

# activity
set -g monitor-activity on
set -g visual-activity off


# -- navigation ----------------------------------------------------------------

# split current window horizontally
bind - split-window -v
# split current window vertically
bind _ split-window -h

# pane navigation
bind -r h select-pane -L  # move left
bind -r j select-pane -D  # move down
bind -r k select-pane -U  # move up
bind -r l select-pane -R  # move right
unbind Left
unbind Down
unbind Up
unbind Right
unbind C-Up   
unbind C-Down 
unbind C-Left 
unbind C-Right

bind > swap-pane -D       # swap current pane with the next one
bind < swap-pane -U       # swap current pane with the previous one

# pane resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# window navigation
bind -r n next-window       # select next window
bind -r p previous-window   # select previous window
bind Tab last-window        # move to last active window

# toggle mouse
set -g mouse on
# bind m run "cut -c3- '#{TMUX_CONF}' | sh -s _toggle_mouse"

# Zoom toggle
bind z resize-pane -Z
bind Enter resize-pane -Z

# -- buffers -------------------------------------------------------------------

bind C-b list-buffers    # list paste buffers
bind C-p paste-buffer -p # paste from the top paste buffer
bind C-P choose-buffer   # choose which buffer to paste from


# -- popup windows -------------------------------------------------------------
# Main launcher menu
bind Space display-menu -T "Launcher" \
  "Lazygit"     g "display-popup -d '#{pane_current_path}' -w 80% -h 80% -E lazygit" \
  "Lazydocker"  d "display-popup -d '#{pane_current_path}' -w 80% -h 80% -E lazydocker" \
  "K9s"         k "display-popup -d '#{pane_current_path}' -w 80% -h 80% -E k9s" \
  "gh-dash"     h "display-popup -d '#{pane_current_path}' -w 90% -h 90% -E 'gh dash'" \
  "OpenCode"    o "display-popup -d '#{pane_current_path}' -w 90% -h 90% -E opencode" \
  "Terminal"    t "display-popup -d '#{pane_current_path}' -w 75% -h 75% -E zsh" \
  "" \
  "Config"      c "display-popup -d '#{pane_current_path}' -w 90% -h 90% -E 'nvim ~/dotfiles'" \
  "" \
  "Scratch Window" s "run-shell 'if [ \"#{window_name}\" = \"scratch\" ]; then tmux last-window; else if tmux list-windows -F \"#{window_name}\" | grep -qx scratch; then tmux select-window -t scratch; else tmux new-window -n scratch -c \"#{pane_current_path}\" zsh; fi; fi'"

# Removed direct keybindings - use Launcher menu (prefix + Space) instead

bind C-s run-shell '
  if [ "#{window_name}" = "scratch" ]; then
    tmux last-window
  else
    if tmux list-windows -F "#{window_name}" | grep -qx scratch; then
      tmux select-window -t scratch
    else
      tmux new-window -n scratch -c "#{pane_current_path}" zsh
    fi
  fi
'

# Session management menu
bind S display-menu -T "Session Management" \
  "New Session"     c "command-prompt -p 'Session name:' 'new-session -d -s \"%%\" ; switch-client -t \"%%\"'" \
  "Rename Session"  r "command-prompt -p 'Rename session:' 'rename-session \"%%\"'" \
  "Kill Session"    q "confirm-before -p 'kill-session #S? (y/n)' kill-session" \
  "" \
  "Switch Session"  s "choose-session" \
  "Detach"          d "detach-client"

# Window management menu  
bind W display-menu -T "Window Management" \
  "New Window"      n "new-window -c '#{pane_current_path}'" \
  "Rename Window"   r "command-prompt -p 'Rename window:' 'rename-window \"%%\"'" \
  "Kill Window"     k "confirm-before -p 'kill-window #W? (y/n)' kill-window" \
  "" \
  "Split Vertical"   v "split-window -h -c '#{pane_current_path}'" \
  "Split Horizontal" s "split-window -v -c '#{pane_current_path}'" \
  "" \
  "Move Left"        h "swap-window -t -1" \
  "Move Right"       l "swap-window -t +1" \
  "" \
  "Choose Window"    w "choose-window"

# Pane management menu
bind P display-menu -T "Pane Management" \
  "Split Vertical"   v "split-window -h -c '#{pane_current_path}'" \
  "Split Horizontal" s "split-window -v -c '#{pane_current_path}'" \
  "" \
  "Kill Pane"        x "confirm-before -p 'kill-pane? (y/n)' kill-pane" \
  "Break Pane"       b "break-pane" \
  "" \
  "Swap Up"          k "swap-pane -U" \
  "Swap Down"        j "swap-pane -D" \
  "Swap Left"        h "swap-pane -L" \
  "Swap Right"       l "swap-pane -R" \
  "" \
  "Zoom"             z "resize-pane -Z" \
  "Mark"             m "select-pane -m"

# -- plugins -------------------------------------------------------------------

set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_window_tabs_enabled on
#set -g @catppuccin_date_time "%Y-%m-%d %H:%M"
set -g @catppuccin_user "on"
set -g @catppuccin_host "on"

# tmux-open settings
set -g @open-S 'https://www.google.com/search?q='

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'dreamsofcode-io/catppuccin-tmux'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-open'
# set -g @plugin 'tmux-plugins/tmux-sensible'

run '~/.tmux/plugins/tpm/tpm'

# Custom SSH status indicator - modifies host module colors
run-shell '~/.tmux/ssh-status.sh'
